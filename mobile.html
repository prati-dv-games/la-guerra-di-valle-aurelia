<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<title>La Guerra di Valle Aurelia</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  width: 100%; height: 100dvh;
  overflow: hidden;
  position: fixed;
  background: #000;
  font-family: 'Courier New', monospace;
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}

#game-container {
  position: fixed;
  top: env(safe-area-inset-top, 0px);
  left: env(safe-area-inset-left, 0px);
  right: env(safe-area-inset-right, 0px);
  bottom: env(safe-area-inset-bottom, 0px);
  display: flex;
  align-items: center;
  justify-content: center;
  background: #000;
}

#game {
  border: none;
  width: 100%;
  height: 100%;
  display: block;
  touch-action: none;
}

/* Transparent touch layer over everything */
#touch-layer {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100dvh;
  z-index: 10;
  touch-action: none;
}

/* D-pad */
#dpad {
  position: fixed;
  bottom: max(2dvh, env(safe-area-inset-bottom, 0px));
  left: max(2vw, env(safe-area-inset-left, 0px));
  width: 34vw;
  height: 34vw;
  max-width: 150px;
  max-height: 150px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  grid-template-rows: 1fr 1fr 1fr;
  gap: 2px;
  z-index: 20;
  pointer-events: none;
}

.dpad-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.12);
  border-radius: 8px;
  color: rgba(255,255,255,0.7);
  font-size: 18px;
  border: 1px solid rgba(255,255,255,0.08);
  pointer-events: none; /* visual only — touch-layer handles hit detection */
}
.dpad-btn:empty { background: transparent; border: none; }
.dpad-btn.active { background: rgba(255,255,255,0.4); color: #fff; }

#dpad-up    { grid-column: 2; grid-row: 1; }
#dpad-left  { grid-column: 1; grid-row: 2; }
#dpad-center{ grid-column: 2; grid-row: 2; background: transparent; border: none; }
#dpad-right { grid-column: 3; grid-row: 2; }
#dpad-down  { grid-column: 2; grid-row: 3; }

/* Action buttons (right side) */
.action-btn {
  position: fixed;
  width: 13vw;
  height: 13vw;
  max-width: 56px;
  max-height: 56px;
  border-radius: 50%;
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.8);
  font-size: 13px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Courier New', monospace;
  z-index: 20;
  pointer-events: none;
}
.action-btn.active { background: rgba(255,255,255,0.4); color: #fff; }

#btn-z   { bottom: max(4dvh, 8px);  right: max(4vw, 8px); background: rgba(76,175,80,0.25); border-color: rgba(76,175,80,0.3); }
#btn-x   { bottom: max(4dvh, 8px);  right: calc(max(4vw, 8px) + 14vw); background: rgba(33,150,243,0.25); border-color: rgba(33,150,243,0.3); }
#btn-q   { bottom: calc(max(4dvh, 8px) + 14vw); right: calc(max(4vw, 8px) + 7vw); background: rgba(233,69,96,0.25); border-color: rgba(233,69,96,0.3); }
#btn-wz  { bottom: calc(max(4dvh, 8px) + 28vw); right: calc(max(4vw, 8px) + 7vw); background: rgba(255,193,7,0.25); border-color: rgba(255,193,7,0.3); font-size: 10px; }

/* Top bar buttons */
.top-btn {
  position: fixed;
  top: max(1dvh, env(safe-area-inset-top, 0px));
  width: 9vw;
  height: 9vw;
  max-width: 38px;
  max-height: 38px;
  border-radius: 6px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.7);
  font-size: 11px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Courier New', monospace;
  z-index: 20;
  pointer-events: none;
}
.top-btn.active { background: rgba(255,255,255,0.4); color: #fff; }

.top-btn.helper { background: rgba(76,175,80,0.15); border-color: rgba(76,175,80,0.2); }
.top-btn.consumable { background: rgba(255,152,0,0.15); border-color: rgba(255,152,0,0.2); }

#top-1 { left: 2vw; }
#top-2 { left: calc(2vw + 10vw); }
#top-3 { left: calc(2vw + 20vw); }
#top-4 { left: calc(2vw + 30vw); }
#top-5 { right: calc(2vw + 20vw); }
#top-6 { right: calc(2vw + 10vw); }
#top-7 { right: 2vw; }

/* Navigation buttons */
.nav-btn {
  position: fixed;
  width: 12vw;
  height: 7vw;
  max-width: 52px;
  max-height: 32px;
  border-radius: 6px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.6);
  font-size: 9px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Courier New', monospace;
  z-index: 20;
  pointer-events: none;
}
.nav-btn.active { background: rgba(255,255,255,0.4); color: #fff; }

#btn-enter { bottom: calc(max(4dvh, 8px) + 42vw); right: max(4vw, 8px); background: rgba(76,175,80,0.2); }
#btn-tab   { bottom: calc(max(4dvh, 8px) + 42vw); right: calc(max(4vw, 8px) + 13vw); }
#btn-esc   { bottom: calc(max(4dvh, 8px) + 50vw); right: calc(max(4vw, 8px) + 6.5vw); }

/* Portrait orientation warning */
#rotate-msg {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100dvh;
  background: #000;
  color: #e94560;
  font-size: 18px;
  z-index: 100;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
  text-align: center;
  padding: 20px;
}
#rotate-msg .icon { font-size: 48px; }

@media (orientation: portrait) {
  #rotate-msg { display: flex; }
  #game-container, #touch-layer, .dpad-btn, .action-btn, .top-btn, .nav-btn, #dpad { display: none !important; }
}

/* Add-to-homescreen hint */
#a2hs {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: rgba(0,0,0,0.9);
  border-top: 2px solid #e94560;
  color: #ccc;
  font-size: 12px;
  padding: 10px 16px;
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: space-between;
}
#a2hs .close-hint { color: #e94560; font-size: 18px; padding: 4px 8px; cursor: pointer; }
</style>
</head>
<body>

<div id="rotate-msg">
  <div class="icon">&#x1F4F1; &#x21BB;</div>
  <div>Ruota il telefono in orizzontale</div>
  <div style="font-size:12px;color:#888;">Landscape mode required</div>
</div>

<div id="a2hs">
  <span>Per schermo intero: Condividi &#x2192; "Aggiungi a Home" &nbsp;/&nbsp; Share &#x2192; Add to Home Screen</span>
  <span class="close-hint" id="close-hint">&times;</span>
</div>

<div id="game-container">
  <iframe id="game" src="index.html" allow="autoplay"></iframe>
</div>

<!-- Transparent touch capture layer -->
<div id="touch-layer"></div>

<!-- Visual-only button overlays (pointer-events:none, just for display) -->
<div id="dpad">
  <div class="dpad-btn" id="dpad-up">&#9650;</div>
  <div class="dpad-btn" id="dpad-left">&#9664;</div>
  <div class="dpad-btn" id="dpad-center"></div>
  <div class="dpad-btn" id="dpad-right">&#9654;</div>
  <div class="dpad-btn" id="dpad-down">&#9660;</div>
</div>

<div class="action-btn" id="btn-z">Z</div>
<div class="action-btn" id="btn-x">X</div>
<div class="action-btn" id="btn-q">Q</div>
<div class="action-btn" id="btn-wz">W+Z</div>

<div class="top-btn helper" id="top-1">1</div>
<div class="top-btn helper" id="top-2">2</div>
<div class="top-btn helper" id="top-3">3</div>
<div class="top-btn helper" id="top-4">4</div>
<div class="top-btn consumable" id="top-5">5</div>
<div class="top-btn consumable" id="top-6">6</div>
<div class="top-btn consumable" id="top-7">7</div>

<div class="nav-btn" id="btn-enter">ENTER</div>
<div class="nav-btn" id="btn-tab">TAB</div>
<div class="nav-btn" id="btn-esc">ESC</div>

<script>
(function() {
  const iframe = document.getElementById('game');
  const touchLayer = document.getElementById('touch-layer');

  // ── Button hit zones ──
  // Each button: { id, keys[], getRect() }
  // getRect returns bounding box — computed live to handle resize
  const buttons = [];

  function reg(id, keys) {
    const el = document.getElementById(id);
    if (!el) return;
    buttons.push({ id, keys, el, getRect: () => el.getBoundingClientRect() });
  }

  // D-pad
  reg('dpad-up',    ['KeyW', 'ArrowUp']);
  reg('dpad-left',  ['KeyA', 'ArrowLeft']);
  reg('dpad-right', ['KeyD', 'ArrowRight']);
  reg('dpad-down',  ['KeyS', 'ArrowDown']);
  // Actions
  reg('btn-z',  ['KeyZ', 'Space']);
  reg('btn-x',  ['KeyX']);
  reg('btn-q',  ['KeyQ']);
  reg('btn-wz', ['KeyW', 'KeyZ']);
  // Top bar
  reg('top-1', ['Digit1']);
  reg('top-2', ['Digit2']);
  reg('top-3', ['Digit3']);
  reg('top-4', ['Digit4']);
  reg('top-5', ['Digit5']);
  reg('top-6', ['Digit6']);
  reg('top-7', ['Digit7']);
  // Nav
  reg('btn-enter', ['Enter']);
  reg('btn-tab',   ['Tab']);
  reg('btn-esc',   ['Escape']);

  function hitTest(x, y) {
    for (const btn of buttons) {
      const r = btn.getRect();
      if (x >= r.left && x <= r.right && y >= r.top && y <= r.bottom) {
        return btn;
      }
    }
    return null;
  }

  // ── Key dispatch into iframe ──
  const keyMap = {
    'KeyW': 'w', 'KeyA': 'a', 'KeyS': 's', 'KeyD': 'd',
    'KeyZ': 'z', 'KeyX': 'x', 'KeyQ': 'q',
    'ArrowUp': 'ArrowUp', 'ArrowDown': 'ArrowDown',
    'ArrowLeft': 'ArrowLeft', 'ArrowRight': 'ArrowRight',
    'Space': ' ', 'Enter': 'Enter', 'Tab': 'Tab', 'Escape': 'Escape',
    'Digit1': '1', 'Digit2': '2', 'Digit3': '3', 'Digit4': '4',
    'Digit5': '5', 'Digit6': '6', 'Digit7': '7'
  };

  function sendKey(code, type) {
    try {
      iframe.contentWindow.dispatchEvent(new KeyboardEvent(type, {
        code: code,
        key: keyMap[code] || code,
        bubbles: true,
        cancelable: true
      }));
    } catch(e) {}
  }

  function sendClick(touchX, touchY) {
    try {
      const rect = iframe.getBoundingClientRect();
      // Pass coordinates relative to iframe viewport — the game's canvas
      // handler will scale them to game space (900x550) itself
      const x = touchX - rect.left;
      const y = touchY - rect.top;
      const canvas = iframe.contentDocument.querySelector('canvas');
      if (!canvas) return;
      // Canvas fills the iframe, so canvas-relative coords = iframe-relative coords
      const cRect = canvas.getBoundingClientRect();
      const cx = touchX - cRect.left;
      const cy = touchY - cRect.top;
      canvas.dispatchEvent(new MouseEvent('mousemove', { clientX: cx, clientY: cy, bubbles: true }));
      canvas.dispatchEvent(new MouseEvent('click', { clientX: cx, clientY: cy, bubbles: true }));
    } catch(e) {}
  }

  // ── Touch state tracking ──
  const activeKeys = new Set();
  const touchMap = new Map(); // touchId → { btn, keys }

  function pressBtn(btn) {
    btn.el.classList.add('active');
    btn.keys.forEach(k => {
      if (!activeKeys.has(k)) {
        activeKeys.add(k);
        sendKey(k, 'keydown');
      }
    });
  }

  function releaseBtn(touchId) {
    const entry = touchMap.get(touchId);
    if (!entry) return;
    entry.btn.el.classList.remove('active');
    entry.keys.forEach(k => {
      // Only release if no other touch holds this key
      let held = false;
      for (const [id, other] of touchMap) {
        if (id !== touchId && other.keys.includes(k)) { held = true; break; }
      }
      if (!held) {
        activeKeys.delete(k);
        sendKey(k, 'keyup');
      }
    });
    touchMap.delete(touchId);
  }

  // ── Touch layer handles ALL touches ──
  touchLayer.addEventListener('touchstart', function(e) {
    e.preventDefault();
    for (const touch of e.changedTouches) {
      const btn = hitTest(touch.clientX, touch.clientY);
      if (btn) {
        touchMap.set(touch.identifier, { btn, keys: btn.keys });
        pressBtn(btn);
      } else {
        // Not on a button — forward as click to game canvas
        sendClick(touch.clientX, touch.clientY);
      }
    }
  }, { passive: false });

  touchLayer.addEventListener('touchmove', function(e) {
    e.preventDefault();
    for (const touch of e.changedTouches) {
      const entry = touchMap.get(touch.identifier);
      if (!entry) continue; // was a click-through touch, ignore move

      const newBtn = hitTest(touch.clientX, touch.clientY);
      if (newBtn !== entry.btn) {
        // Finger slid to a different button (or off buttons)
        releaseBtn(touch.identifier);
        if (newBtn) {
          touchMap.set(touch.identifier, { btn: newBtn, keys: newBtn.keys });
          pressBtn(newBtn);
        }
      }
    }
  }, { passive: false });

  touchLayer.addEventListener('touchend', function(e) {
    e.preventDefault();
    for (const touch of e.changedTouches) {
      releaseBtn(touch.identifier);
    }
  }, { passive: false });

  touchLayer.addEventListener('touchcancel', function(e) {
    e.preventDefault();
    for (const touch of e.changedTouches) {
      releaseBtn(touch.identifier);
    }
  }, { passive: false });

  // ── Add-to-homescreen hint (only in browser, not standalone) ──
  const a2hs = document.getElementById('a2hs');
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (!isStandalone) {
    // Show hint after a short delay
    setTimeout(() => { a2hs.style.display = 'flex'; }, 2000);
    document.getElementById('close-hint').addEventListener('click', () => {
      a2hs.style.display = 'none';
    });
    // Auto-hide after 8 seconds
    setTimeout(() => { a2hs.style.display = 'none'; }, 10000);
  }

  // ── Scroll address bar away on iOS Safari ──
  window.addEventListener('load', () => {
    setTimeout(() => { window.scrollTo(0, 1); }, 100);
  });
})();
</script>
</body>
</html>
