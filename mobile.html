<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>La Guerra di Valle Aurelia - Mobile</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  position: fixed;
  touch-action: none;
  background: #000;
  font-family: 'Courier New', monospace;
  user-select: none;
  -webkit-user-select: none;
}

#game-container {
  position: relative;
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

#game {
  border: none;
  width: 100vw;
  height: 100vh;
  display: block;
}

/* Touch controls overlay */
#controls {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 10;
}

#controls > * {
  pointer-events: auto;
}

/* D-pad */
#dpad {
  position: fixed;
  bottom: 4vh;
  left: 3vw;
  width: 36vw;
  height: 36vw;
  max-width: 160px;
  max-height: 160px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  grid-template-rows: 1fr 1fr 1fr;
  gap: 2px;
}

.dpad-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.12);
  border-radius: 8px;
  color: rgba(255,255,255,0.7);
  font-size: 20px;
  touch-action: none;
  border: 1px solid rgba(255,255,255,0.08);
}
.dpad-btn:empty { background: transparent; border: none; }
.dpad-btn.active { background: rgba(255,255,255,0.35); }

#dpad-up    { grid-column: 2; grid-row: 1; }
#dpad-left  { grid-column: 1; grid-row: 2; }
#dpad-center{ grid-column: 2; grid-row: 2; background: transparent; border: none; }
#dpad-right { grid-column: 3; grid-row: 2; }
#dpad-down  { grid-column: 2; grid-row: 3; }

/* Action buttons (right side) */
.action-btn {
  position: fixed;
  width: 13vw;
  height: 13vw;
  max-width: 58px;
  max-height: 58px;
  border-radius: 50%;
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.8);
  font-size: 13px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: none;
  font-family: 'Courier New', monospace;
}
.action-btn.active { background: rgba(255,255,255,0.35); }

#btn-z   { bottom: 6vh;  right: 5vw; background: rgba(76,175,80,0.25); border-color: rgba(76,175,80,0.3); }
#btn-x   { bottom: 6vh;  right: calc(5vw + 14vw); background: rgba(33,150,243,0.25); border-color: rgba(33,150,243,0.3); }
#btn-q   { bottom: calc(6vh + 14vw); right: calc(5vw + 7vw); background: rgba(233,69,96,0.25); border-color: rgba(233,69,96,0.3); }
#btn-wz  { bottom: calc(6vh + 14vw + 14vw); right: calc(5vw + 7vw); background: rgba(255,193,7,0.25); border-color: rgba(255,193,7,0.3); font-size: 10px; }

/* Top bar buttons */
.top-btn {
  position: fixed;
  top: 1vh;
  width: 9vw;
  height: 9vw;
  max-width: 40px;
  max-height: 40px;
  border-radius: 6px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.7);
  font-size: 12px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: none;
  font-family: 'Courier New', monospace;
}
.top-btn.active { background: rgba(255,255,255,0.35); }

.top-btn.helper { background: rgba(76,175,80,0.15); border-color: rgba(76,175,80,0.2); }
.top-btn.consumable { background: rgba(255,152,0,0.15); border-color: rgba(255,152,0,0.2); }

#top-1 { left: 2vw; }
#top-2 { left: calc(2vw + 10vw); }
#top-3 { left: calc(2vw + 20vw); }
#top-4 { left: calc(2vw + 30vw); }
#top-5 { right: calc(2vw + 20vw); }
#top-6 { right: calc(2vw + 10vw); }
#top-7 { right: 2vw; }

/* Navigation buttons (bottom right) */
.nav-btn {
  position: fixed;
  width: 12vw;
  height: 8vw;
  max-width: 54px;
  max-height: 36px;
  border-radius: 6px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.6);
  font-size: 9px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: none;
  font-family: 'Courier New', monospace;
}
.nav-btn.active { background: rgba(255,255,255,0.35); }

#btn-enter { bottom: calc(6vh + 14vw + 14vw + 14vw); right: 5vw; background: rgba(76,175,80,0.2); }
#btn-tab   { bottom: calc(6vh + 14vw + 14vw + 14vw); right: calc(5vw + 13vw); }
#btn-esc   { bottom: calc(6vh + 14vw + 14vw + 14vw + 9vw); right: calc(5vw + 6.5vw); }

/* Portrait orientation warning */
#rotate-msg {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: #000;
  color: #e94560;
  font-size: 18px;
  z-index: 100;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
}
#rotate-msg .icon { font-size: 48px; }

@media (orientation: portrait) {
  #rotate-msg { display: flex; }
  #game-container, #controls { display: none; }
}
</style>
</head>
<body>

<div id="rotate-msg">
  <div class="icon">&#x1F4F1;&#x21BB;</div>
  <div>Ruota il telefono in orizzontale</div>
  <div style="font-size:12px;color:#888;">Landscape mode required</div>
</div>

<div id="game-container">
  <iframe id="game" src="index.html" allow="autoplay"></iframe>
</div>

<div id="controls">
  <!-- D-pad -->
  <div id="dpad">
    <div class="dpad-btn" id="dpad-up" data-keys="KeyW,ArrowUp">&#9650;</div>
    <div class="dpad-btn" id="dpad-left" data-keys="KeyA,ArrowLeft">&#9664;</div>
    <div class="dpad-btn" id="dpad-center"></div>
    <div class="dpad-btn" id="dpad-right" data-keys="KeyD,ArrowRight">&#9654;</div>
    <div class="dpad-btn" id="dpad-down" data-keys="KeyS,ArrowDown">&#9660;</div>
  </div>

  <!-- Action buttons -->
  <div class="action-btn" id="btn-z" data-keys="KeyZ,Space">Z</div>
  <div class="action-btn" id="btn-x" data-keys="KeyX">X</div>
  <div class="action-btn" id="btn-q" data-keys="KeyQ">Q</div>
  <div class="action-btn" id="btn-wz" data-keys="KeyW,KeyZ">W+Z</div>

  <!-- Top bar - helpers -->
  <div class="top-btn helper" id="top-1" data-keys="Digit1">1</div>
  <div class="top-btn helper" id="top-2" data-keys="Digit2">2</div>
  <div class="top-btn helper" id="top-3" data-keys="Digit3">3</div>
  <div class="top-btn helper" id="top-4" data-keys="Digit4">4</div>

  <!-- Top bar - consumables -->
  <div class="top-btn consumable" id="top-5" data-keys="Digit5">5</div>
  <div class="top-btn consumable" id="top-6" data-keys="Digit6">6</div>
  <div class="top-btn consumable" id="top-7" data-keys="Digit7">7</div>

  <!-- Navigation -->
  <div class="nav-btn" id="btn-enter" data-keys="Enter">ENTER</div>
  <div class="nav-btn" id="btn-tab" data-keys="Tab">TAB</div>
  <div class="nav-btn" id="btn-esc" data-keys="Escape">ESC</div>
</div>

<script>
(function() {
  const iframe = document.getElementById('game');
  const activeKeys = new Set();

  // Send keyboard event to iframe
  function sendKey(code, type) {
    try {
      const keyMap = {
        'KeyW': 'w', 'KeyA': 'a', 'KeyS': 's', 'KeyD': 'd',
        'KeyZ': 'z', 'KeyX': 'x', 'KeyQ': 'q',
        'ArrowUp': 'ArrowUp', 'ArrowDown': 'ArrowDown',
        'ArrowLeft': 'ArrowLeft', 'ArrowRight': 'ArrowRight',
        'Space': ' ', 'Enter': 'Enter', 'Tab': 'Tab', 'Escape': 'Escape',
        'Digit1': '1', 'Digit2': '2', 'Digit3': '3', 'Digit4': '4',
        'Digit5': '5', 'Digit6': '6', 'Digit7': '7'
      };
      const event = new KeyboardEvent(type, {
        code: code,
        key: keyMap[code] || code,
        bubbles: true,
        cancelable: true
      });
      iframe.contentWindow.dispatchEvent(event);
    } catch(e) {
      // Cross-origin may block â€” requires same-origin serving
    }
  }

  // Parse data-keys attribute into array
  function getKeys(el) {
    const attr = el.getAttribute('data-keys');
    return attr ? attr.split(',') : [];
  }

  // Track which touches are on which buttons
  const touchMap = new Map(); // touchId -> { el, keys }

  function handleTouchStart(e) {
    e.preventDefault();
    for (const touch of e.changedTouches) {
      const el = document.elementFromPoint(touch.clientX, touch.clientY);
      if (!el || !el.getAttribute('data-keys')) continue;
      const keys = getKeys(el);
      touchMap.set(touch.identifier, { el, keys });
      el.classList.add('active');
      keys.forEach(k => {
        if (!activeKeys.has(k)) {
          activeKeys.add(k);
          sendKey(k, 'keydown');
        }
      });
    }
  }

  function handleTouchEnd(e) {
    e.preventDefault();
    for (const touch of e.changedTouches) {
      const entry = touchMap.get(touch.identifier);
      if (!entry) continue;
      entry.el.classList.remove('active');
      // Release keys that no other active touch is holding
      entry.keys.forEach(k => {
        let stillHeld = false;
        for (const [id, other] of touchMap) {
          if (id !== touch.identifier && other.keys.includes(k)) {
            stillHeld = true;
            break;
          }
        }
        if (!stillHeld) {
          activeKeys.delete(k);
          sendKey(k, 'keyup');
        }
      });
      touchMap.delete(touch.identifier);
    }
  }

  function handleTouchMove(e) {
    e.preventDefault();
    // For D-pad: allow sliding between directions
    for (const touch of e.changedTouches) {
      const el = document.elementFromPoint(touch.clientX, touch.clientY);
      const entry = touchMap.get(touch.identifier);
      if (!entry) continue;

      // If finger moved to a different button
      if (el !== entry.el) {
        // Release old keys
        entry.el.classList.remove('active');
        entry.keys.forEach(k => {
          let stillHeld = false;
          for (const [id, other] of touchMap) {
            if (id !== touch.identifier && other.keys.includes(k)) {
              stillHeld = true;
              break;
            }
          }
          if (!stillHeld) {
            activeKeys.delete(k);
            sendKey(k, 'keyup');
          }
        });

        // Press new keys if valid button
        if (el && el.getAttribute('data-keys')) {
          const newKeys = getKeys(el);
          entry.el = el;
          entry.keys = newKeys;
          el.classList.add('active');
          newKeys.forEach(k => {
            if (!activeKeys.has(k)) {
              activeKeys.add(k);
              sendKey(k, 'keydown');
            }
          });
        } else {
          // Finger moved off all buttons
          touchMap.delete(touch.identifier);
        }
      }
    }
  }

  // Attach touch listeners to controls overlay
  const controls = document.getElementById('controls');
  controls.addEventListener('touchstart', handleTouchStart, { passive: false });
  controls.addEventListener('touchend', handleTouchEnd, { passive: false });
  controls.addEventListener('touchcancel', handleTouchEnd, { passive: false });
  controls.addEventListener('touchmove', handleTouchMove, { passive: false });

  // Forward touch on iframe area as mouse clicks (for menu/shop/hub)
  const gameContainer = document.getElementById('game-container');
  gameContainer.addEventListener('touchstart', function(e) {
    // Only handle touches not on control buttons
    const el = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
    if (el && el.getAttribute('data-keys')) return; // handled by controls

    try {
      const rect = iframe.getBoundingClientRect();
      const touch = e.changedTouches[0];
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;

      // Scale to game canvas coordinates (900x550)
      const scaleX = 900 / rect.width;
      const scaleY = 550 / rect.height;
      const gameX = x * scaleX;
      const gameY = y * scaleY;

      const mouseDown = new MouseEvent('mousedown', {
        clientX: gameX, clientY: gameY,
        bubbles: true, cancelable: true
      });
      const mouseUp = new MouseEvent('mouseup', {
        clientX: gameX, clientY: gameY,
        bubbles: true, cancelable: true
      });
      const click = new MouseEvent('click', {
        clientX: gameX, clientY: gameY,
        bubbles: true, cancelable: true
      });

      const canvas = iframe.contentDocument.querySelector('canvas');
      if (canvas) {
        canvas.dispatchEvent(mouseDown);
        setTimeout(() => {
          canvas.dispatchEvent(mouseUp);
          canvas.dispatchEvent(click);
        }, 50);
      }
    } catch(e) {
      // Cross-origin protection
    }
  }, { passive: false });

  // Prevent default touch behaviors on body
  document.body.addEventListener('touchstart', function(e) { e.preventDefault(); }, { passive: false });
  document.body.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });

  // Fullscreen on first tap (iOS Safari)
  let fullscreenRequested = false;
  document.addEventListener('touchstart', function() {
    if (!fullscreenRequested && document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen().catch(() => {});
      fullscreenRequested = true;
    }
  }, { once: true });
})();
</script>
</body>
</html>
