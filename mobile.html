<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<title>La Guerra di Valle Aurelia</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  width: 100%; height: 100dvh;
  overflow: hidden;
  position: fixed;
  background: #000;
  font-family: 'Courier New', monospace;
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}

#game-container {
  position: fixed;
  top: env(safe-area-inset-top, 0px);
  left: env(safe-area-inset-left, 0px);
  right: env(safe-area-inset-right, 0px);
  bottom: env(safe-area-inset-bottom, 0px);
  display: flex;
  align-items: center;
  justify-content: center;
  background: #000;
}

#game {
  border: none;
  width: 100%;
  height: 100%;
  display: block;
  touch-action: none;
}

/* Transparent touch layer over everything */
#touch-layer {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100dvh;
  z-index: 10;
  touch-action: none;
}

/* D-pad (left side — left/right only + Q above) */
#dpad {
  position: fixed;
  bottom: max(2dvh, env(safe-area-inset-bottom, 0px));
  left: max(2vw, env(safe-area-inset-left, 0px));
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  z-index: 20;
  pointer-events: none;
}

#dpad-arrows {
  display: flex;
  gap: 4px;
}

.dpad-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.12);
  border-radius: 8px;
  color: rgba(255,255,255,0.7);
  font-size: 20px;
  border: 1px solid rgba(255,255,255,0.08);
  pointer-events: none;
  width: 17vw;
  height: 15vw;
  max-width: 72px;
  max-height: 64px;
}
.dpad-btn.active { background: rgba(255,255,255,0.4); color: #fff; }

#dpad-q {
  width: 22vw;
  max-width: 96px;
  height: 13vw;
  max-height: 56px;
  background: rgba(255,215,0,0.25);
  border-color: rgba(255,215,0,0.3);
  font-size: 13px;
  font-weight: bold;
}

/* Action buttons container (right side — mirrors D-pad structure) */
#actions {
  position: fixed;
  bottom: max(2dvh, env(safe-area-inset-bottom, 0px));
  right: max(2vw, env(safe-area-inset-right, 0px));
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  z-index: 20;
  pointer-events: none;
}
#action-row {
  display: flex;
  gap: 4px;
}

.action-btn {
  border-radius: 10px;
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.8);
  font-size: 15px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Courier New', monospace;
  pointer-events: none;
}
.action-btn.active { background: rgba(255,255,255,0.4); color: #fff; }

#btn-x {
  width: 17vw; max-width: 72px;
  height: 15vw; max-height: 64px;
  background: rgba(33,150,243,0.25); border-color: rgba(33,150,243,0.3);
}
#btn-w {
  width: 17vw; max-width: 72px;
  height: 15vw; max-height: 64px;
  background: rgba(76,175,80,0.25); border-color: rgba(76,175,80,0.3);
}
#btn-atk {
  width: calc(34vw + 4px); max-width: 148px;
  height: 15vw; max-height: 64px;
  background: rgba(233,69,96,0.25); border-color: rgba(233,69,96,0.3);
}

/* Top bar flex container */
#top-bar {
  position: fixed;
  top: max(1dvh, env(safe-area-inset-top, 0px));
  left: 2vw;
  right: 2vw;
  display: flex;
  align-items: center;
  gap: 1vw;
  z-index: 20;
  pointer-events: none;
}

/* Top bar buttons */
.top-btn {
  width: 9vw;
  height: 9vw;
  max-width: 38px;
  max-height: 38px;
  border-radius: 6px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.7);
  font-size: 11px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Courier New', monospace;
  pointer-events: none;
  flex-shrink: 0;
}
.top-btn.active { background: rgba(255,255,255,0.4); color: #fff; }

.top-btn.helper { background: rgba(76,175,80,0.15); border-color: rgba(76,175,80,0.2); }
.top-btn.consumable { background: rgba(255,152,0,0.15); border-color: rgba(255,152,0,0.2); }

/* Credits button — small, bottom center, unobtrusive */
#btn-credits {
  position: fixed;
  bottom: max(1dvh, env(safe-area-inset-bottom, 0px));
  left: 50%;
  transform: translateX(-50%);
  width: 16vw; max-width: 68px;
  height: 6vw; max-height: 26px;
  border-radius: 4px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.05);
  color: rgba(255,255,255,0.35);
  font-size: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Courier New', monospace;
  z-index: 20;
  pointer-events: none;
}
#btn-credits.active { background: rgba(255,255,255,0.2); color: #fff; }

/* Navigation buttons */
.nav-btn {
  width: 12vw;
  height: 7vw;
  max-width: 52px;
  max-height: 32px;
  border-radius: 6px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.6);
  font-size: 9px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Courier New', monospace;
  pointer-events: none;
  flex-shrink: 0;
}
.nav-btn.active { background: rgba(255,255,255,0.4); color: #fff; }

#btn-enter { background: rgba(76,175,80,0.2); }

/* Portrait orientation warning */
#rotate-msg {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100dvh;
  background: #000;
  color: #e94560;
  font-size: 18px;
  z-index: 100;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
  text-align: center;
  padding: 20px;
}
#rotate-msg .icon { font-size: 48px; }

@media (orientation: portrait) {
  #rotate-msg { display: flex; }
  #game-container, #touch-layer, .dpad-btn, .action-btn, .top-btn, .nav-btn, #dpad, #top-bar, #actions { display: none !important; }
}

/* Add-to-homescreen hint */
#a2hs {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: rgba(0,0,0,0.9);
  border-top: 2px solid #e94560;
  color: #ccc;
  font-size: 12px;
  padding: 10px 16px;
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: space-between;
}
#a2hs .close-hint { color: #e94560; font-size: 18px; padding: 4px 8px; cursor: pointer; }

/* Code keyboard overlay for credits screen */
#code-keyboard {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: rgba(10,10,20,0.95);
  border-top: 2px solid #e94560;
  z-index: 30;
  padding: 6px 4px env(safe-area-inset-bottom, 4px);
  pointer-events: auto;
  touch-action: none;
}
#code-keyboard.visible { display: block; }
#kb-display {
  text-align: center;
  color: #fff;
  font-size: 16px;
  font-family: 'Courier New', monospace;
  padding: 4px 0 6px;
  letter-spacing: 2px;
}
#kb-display span { color: #555; }
#kb-rows {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
.kb-row {
  display: flex;
  gap: 3px;
}
.kb-key {
  width: 8.5vw; height: 7.5vw;
  max-width: 42px; max-height: 36px;
  border-radius: 5px;
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.15);
  color: #ddd;
  font-size: 13px;
  font-weight: bold;
  font-family: 'Courier New', monospace;
  display: flex;
  align-items: center;
  justify-content: center;
}
.kb-key.special {
  width: auto;
  padding: 0 10px;
  font-size: 10px;
}
.kb-key.del { background: rgba(255,152,0,0.25); border-color: rgba(255,152,0,0.3); }
.kb-key.close-kb { background: rgba(233,69,96,0.3); border-color: rgba(233,69,96,0.4); color: #e94560; }
.kb-key:active, .kb-key.pressed { background: rgba(255,255,255,0.35); color: #fff; }
</style>
</head>
<body>

<div id="rotate-msg">
  <div class="icon">&#x1F4F1; &#x21BB;</div>
  <div>Ruota il telefono in orizzontale</div>
  <div style="font-size:12px;color:#888;">Landscape mode required</div>
</div>

<div id="a2hs">
  <span>Per schermo intero: Condividi &#x2192; "Aggiungi a Home" &nbsp;/&nbsp; Share &#x2192; Add to Home Screen</span>
  <span class="close-hint" id="close-hint">&times;</span>
</div>

<div id="game-container">
  <iframe id="game" src="index.html" allow="autoplay"></iframe>
</div>

<!-- Transparent touch capture layer -->
<div id="touch-layer"></div>

<!-- Visual-only button overlays (pointer-events:none, just for display) -->
<!-- Left side: arrows + Q above -->
<div id="dpad">
  <div class="dpad-btn" id="dpad-q">Q</div>
  <div id="dpad-arrows">
    <div class="dpad-btn" id="dpad-left">&#9664;</div>
    <div class="dpad-btn" id="dpad-right">&#9654;</div>
  </div>
</div>

<!-- Right side: X and W on top, ATK wide below (mirrors D-pad) -->
<div id="actions">
  <div id="action-row">
    <div class="action-btn" id="btn-x">X</div>
    <div class="action-btn" id="btn-w">W</div>
  </div>
  <div class="action-btn" id="btn-atk">ATK</div>
</div>

<!-- Top bar: helpers 1-4, consumables 5-7, spacer, nav (right) -->
<div id="top-bar">
  <div class="top-btn helper" id="top-1">1</div>
  <div class="top-btn helper" id="top-2">2</div>
  <div class="top-btn helper" id="top-3">3</div>
  <div class="top-btn helper" id="top-4">4</div>
  <div class="top-btn consumable" id="top-5">5</div>
  <div class="top-btn consumable" id="top-6">6</div>
  <div class="top-btn consumable" id="top-7">7</div>
  <div style="flex:1"></div>
  <div class="nav-btn" id="btn-enter">OK</div>
  <div class="nav-btn" id="btn-tab">TAB</div>
  <div class="nav-btn" id="btn-esc">ESC</div>
</div>

<!-- Credits — small unobtrusive button bottom center -->
<div id="btn-credits">Crediti</div>

<!-- Code keyboard overlay (shown when credits are open) -->
<div id="code-keyboard">
  <div id="kb-display"><span>Inserisci codice...</span></div>
  <div id="kb-rows">
    <div class="kb-row">
      <div class="kb-key" data-key="Q">Q</div>
      <div class="kb-key" data-key="W">W</div>
      <div class="kb-key" data-key="E">E</div>
      <div class="kb-key" data-key="R">R</div>
      <div class="kb-key" data-key="T">T</div>
      <div class="kb-key" data-key="Y">Y</div>
      <div class="kb-key" data-key="U">U</div>
      <div class="kb-key" data-key="I">I</div>
      <div class="kb-key" data-key="O">O</div>
      <div class="kb-key" data-key="P">P</div>
    </div>
    <div class="kb-row">
      <div class="kb-key" data-key="A">A</div>
      <div class="kb-key" data-key="S">S</div>
      <div class="kb-key" data-key="D">D</div>
      <div class="kb-key" data-key="F">F</div>
      <div class="kb-key" data-key="G">G</div>
      <div class="kb-key" data-key="H">H</div>
      <div class="kb-key" data-key="J">J</div>
      <div class="kb-key" data-key="K">K</div>
      <div class="kb-key" data-key="L">L</div>
    </div>
    <div class="kb-row">
      <div class="kb-key" data-key="Z">Z</div>
      <div class="kb-key" data-key="X">X</div>
      <div class="kb-key" data-key="C">C</div>
      <div class="kb-key" data-key="V">V</div>
      <div class="kb-key" data-key="B">B</div>
      <div class="kb-key" data-key="N">N</div>
      <div class="kb-key" data-key="M">M</div>
      <div class="kb-key special del" data-key="DEL">DEL</div>
      <div class="kb-key special close-kb" data-key="ESC">ESC</div>
    </div>
  </div>
</div>

<script>
(function() {
  const iframe = document.getElementById('game');
  const touchLayer = document.getElementById('touch-layer');

  // ── Code keyboard state (declared early so pressBtn/releaseBtn can use it) ──
  const codeKeyboard = document.getElementById('code-keyboard');
  const kbDisplay = document.getElementById('kb-display');
  let kbInput = '';
  let kbVisible = false;

  // ── Button hit zones ──
  // Each button: { id, keys[], getRect() }
  // getRect returns bounding box — computed live to handle resize
  const buttons = [];

  function reg(id, keys) {
    const el = document.getElementById(id);
    if (!el) return;
    buttons.push({ id, keys, el, getRect: () => el.getBoundingClientRect() });
  }

  // D-pad (left side)
  reg('dpad-left',  ['KeyA', 'ArrowLeft']);
  reg('dpad-right', ['KeyD', 'ArrowRight']);
  reg('dpad-q',     ['KeyQ']);
  // Actions (right side)
  reg('btn-x',   ['KeyX']);
  reg('btn-w',   ['KeyW']);
  reg('btn-atk', ['KeyZ', 'Space']);
  // Top bar — helpers + consumables
  reg('top-1', ['Digit1']);
  reg('top-2', ['Digit2']);
  reg('top-3', ['Digit3']);
  reg('top-4', ['Digit4']);
  reg('top-5', ['Digit5']);
  reg('top-6', ['Digit6']);
  reg('top-7', ['Digit7']);
  // Nav
  reg('btn-enter', ['Enter']);
  reg('btn-tab',   ['Tab']);
  reg('btn-esc',   ['Escape']);

  // Credits — special: simulates a click on the in-game credits button
  (function() {
    const el = document.getElementById('btn-credits');
    if (!el) return;
    buttons.push({ id: 'btn-credits', keys: [], el, getRect: () => el.getBoundingClientRect(), isCredits: true });
  })();

  // Cache button rects — recompute only on resize
  let cachedRects = [];
  function updateRects() {
    cachedRects = buttons.map(btn => ({ btn, r: btn.getRect() }));
  }
  updateRects();
  window.addEventListener('resize', updateRects);

  function hitTest(x, y) {
    // Use live rects (not cached) to handle flex layout shifts
    for (const btn of buttons) {
      const r = btn.getRect();
      if (x >= r.left && x <= r.right && y >= r.top && y <= r.bottom) {
        return btn;
      }
    }
    return null;
  }

  // ── Key dispatch into iframe ──
  const keyMap = {
    'KeyA': 'a', 'KeyB': 'b', 'KeyC': 'c', 'KeyD': 'd', 'KeyE': 'e',
    'KeyF': 'f', 'KeyG': 'g', 'KeyH': 'h', 'KeyI': 'i', 'KeyJ': 'j',
    'KeyK': 'k', 'KeyL': 'l', 'KeyM': 'm', 'KeyN': 'n', 'KeyO': 'o',
    'KeyP': 'p', 'KeyQ': 'q', 'KeyR': 'r', 'KeyS': 's', 'KeyT': 't',
    'KeyU': 'u', 'KeyV': 'v', 'KeyW': 'w', 'KeyX': 'x', 'KeyY': 'y',
    'KeyZ': 'z',
    'ArrowUp': 'ArrowUp', 'ArrowDown': 'ArrowDown',
    'ArrowLeft': 'ArrowLeft', 'ArrowRight': 'ArrowRight',
    'Space': ' ', 'Enter': 'Enter', 'Tab': 'Tab', 'Escape': 'Escape',
    'Backspace': 'Backspace',
    'Digit1': '1', 'Digit2': '2', 'Digit3': '3', 'Digit4': '4',
    'Digit5': '5', 'Digit6': '6', 'Digit7': '7'
  };

  function sendKey(code, type) {
    try {
      iframe.contentWindow.dispatchEvent(new KeyboardEvent(type, {
        code: code,
        key: keyMap[code] || code,
        bubbles: true,
        cancelable: true
      }));
    } catch(e) {}
  }

  function sendClick(touchX, touchY) {
    try {
      const rect = iframe.getBoundingClientRect();
      // Pass coordinates relative to iframe viewport — the game's canvas
      // handler will scale them to game space (900x550) itself
      const x = touchX - rect.left;
      const y = touchY - rect.top;
      const canvas = iframe.contentDocument.querySelector('canvas');
      if (!canvas) return;
      // Canvas fills the iframe, so canvas-relative coords = iframe-relative coords
      const cRect = canvas.getBoundingClientRect();
      const cx = touchX - cRect.left;
      const cy = touchY - cRect.top;
      canvas.dispatchEvent(new MouseEvent('mousemove', { clientX: cx, clientY: cy, bubbles: true }));
      canvas.dispatchEvent(new MouseEvent('click', { clientX: cx, clientY: cy, bubbles: true }));
    } catch(e) {}
  }

  // ── Touch state tracking ──
  const activeKeys = new Set();
  const touchMap = new Map(); // touchId → { btn, keys }

  function pressBtn(btn) {
    btn.el.classList.add('active');
    if (btn.isCredits) {
      // Click the in-game credits button (bottom-right of 900x550 canvas)
      try {
        const canvas = iframe.contentDocument.querySelector('canvas');
        if (canvas) {
          const cRect = canvas.getBoundingClientRect();
          // Credits button in game: x=820-890, y=522-550 (canvas coords ~860, 536)
          const scaleX = cRect.width / 900, scaleY = cRect.height / 550;
          const cx = cRect.left + 860 * scaleX, cy = cRect.top + 536 * scaleY;
          canvas.dispatchEvent(new MouseEvent('mousemove', { clientX: cx, clientY: cy, bubbles: true }));
          canvas.dispatchEvent(new MouseEvent('click', { clientX: cx, clientY: cy, bubbles: true }));
        }
      } catch(e) {}
      setTimeout(showCodeKeyboard, 100);
      return;
    }
    btn.keys.forEach(k => {
      if (!activeKeys.has(k)) {
        activeKeys.add(k);
        sendKey(k, 'keydown');
      }
    });
  }

  function releaseBtn(touchId) {
    const entry = touchMap.get(touchId);
    if (!entry) return;
    if (entry.keys.includes('Escape') && kbVisible) hideCodeKeyboard();
    entry.btn.el.classList.remove('active');
    entry.keys.forEach(k => {
      // Only release if no other touch holds this key
      let held = false;
      for (const [id, other] of touchMap) {
        if (id !== touchId && other.keys.includes(k)) { held = true; break; }
      }
      if (!held) {
        activeKeys.delete(k);
        sendKey(k, 'keyup');
      }
    });
    touchMap.delete(touchId);
  }

  // ── Touch layer handles ALL touches ──
  touchLayer.addEventListener('touchstart', function(e) {
    e.preventDefault();
    for (const touch of e.changedTouches) {
      const btn = hitTest(touch.clientX, touch.clientY);
      if (btn) {
        touchMap.set(touch.identifier, { btn, keys: btn.keys });
        pressBtn(btn);
      } else {
        // Not on a button — forward as click to game canvas
        sendClick(touch.clientX, touch.clientY);
      }
    }
  }, { passive: false });

  touchLayer.addEventListener('touchmove', function(e) {
    e.preventDefault();
    for (const touch of e.changedTouches) {
      const entry = touchMap.get(touch.identifier);
      if (!entry) continue; // was a click-through touch, ignore move

      const newBtn = hitTest(touch.clientX, touch.clientY);
      if (newBtn !== entry.btn) {
        // Finger slid to a different button (or off buttons)
        releaseBtn(touch.identifier);
        if (newBtn) {
          touchMap.set(touch.identifier, { btn: newBtn, keys: newBtn.keys });
          pressBtn(newBtn);
        }
      }
    }
  }, { passive: false });

  touchLayer.addEventListener('touchend', function(e) {
    e.preventDefault();
    for (const touch of e.changedTouches) {
      releaseBtn(touch.identifier);
    }
  }, { passive: false });

  touchLayer.addEventListener('touchcancel', function(e) {
    e.preventDefault();
    for (const touch of e.changedTouches) {
      releaseBtn(touch.identifier);
    }
  }, { passive: false });

  // ── Code keyboard overlay for credits ──
  function showCodeKeyboard() {
    kbInput = '';
    updateKbDisplay();
    codeKeyboard.classList.add('visible');
    kbVisible = true;
    updateRects(); // recache since keyboard changes layout
  }

  function hideCodeKeyboard() {
    codeKeyboard.classList.remove('visible');
    kbVisible = false;
    kbInput = '';
    updateRects();
  }

  function updateKbDisplay() {
    if (kbInput) {
      kbDisplay.textContent = kbInput;
    } else {
      kbDisplay.innerHTML = '<span>Inserisci codice...</span>';
    }
  }

  // Handle keyboard key taps
  codeKeyboard.addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    const touch = e.changedTouches[0];
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    if (!el || !el.classList.contains('kb-key')) return;

    el.classList.add('pressed');
    setTimeout(() => el.classList.remove('pressed'), 120);

    const key = el.dataset.key;
    if (key === 'ESC') {
      hideCodeKeyboard();
      sendKey('Escape', 'keydown');
      setTimeout(() => sendKey('Escape', 'keyup'), 50);
      return;
    }
    if (key === 'DEL') {
      kbInput = kbInput.slice(0, -1);
      updateKbDisplay();
      sendKey('Backspace', 'keydown');
      setTimeout(() => sendKey('Backspace', 'keyup'), 50);
      return;
    }
    // Letter key
    if (kbInput.length < 12) {
      kbInput += key;
      updateKbDisplay();
      const code = 'Key' + key;
      sendKey(code, 'keydown');
      setTimeout(() => sendKey(code, 'keyup'), 50);
    }
  }, { passive: false });

  // ── Add-to-homescreen hint (only in browser, not standalone) ──
  const a2hs = document.getElementById('a2hs');
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (!isStandalone) {
    // Show hint after a short delay
    setTimeout(() => { a2hs.style.display = 'flex'; }, 2000);
    document.getElementById('close-hint').addEventListener('click', () => {
      a2hs.style.display = 'none';
    });
    // Auto-hide after 8 seconds
    setTimeout(() => { a2hs.style.display = 'none'; }, 10000);
  }

  // ── Scroll address bar away on iOS Safari ──
  window.addEventListener('load', () => {
    setTimeout(() => { window.scrollTo(0, 1); }, 100);
  });
})();
</script>
</body>
</html>
